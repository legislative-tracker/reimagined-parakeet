name: Reusable - Build Frontend

on:
  workflow_call:
    inputs:
      node-version:
        required: false
        type: number
        default: 24
        description: "The version of Node.js to use for the build."
      app-version:
        required: false
        type: string
        default: "0.0.0-snapshot"
        description: "The semantic version to inject into the Angular environment files."

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ inputs.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install Dependencies
        working-directory: frontend
        run: npm ci

      - name: Create Config File
        run: |
          echo '${{ secrets.APP_CONFIG_JSON }}' > frontend/public/config.json

      - name: Inject Versioning
        working-directory: frontend
        run: |
          # Dynamically create/update the version file for the Angular application
          echo "export const appVersion = '${{ inputs.app-version }}';" > src/environments/version.ts
          echo "âœ… Injected version ${{ inputs.app-version }} into src/environments/version.ts"

      - name: Run Tests & Coverage
        working-directory: frontend
        run: |
          npm run test:coverage

      - name: Archive Coverage Results
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage
          path: frontend/coverage
          retention-days: 1

      - name: Build Angular Application
        working-directory: frontend
        run: npm run build

      - name: Archive Production Artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist
          retention-days: 1
