rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * HELPER: App Check Verification
     * Ensures the request originates from your authentic Angular portal.
     */
    function isAppCheckVerified() {
      return request.appCheck != null;
    }

    /**
     * HELPER: Admin Verification
     * Checks for the 'admin' custom claim set via the Admin SDK.
     */
    function isAdmin() {
      return request.auth != null && request.auth.token.admin == true;
    }

    /**
     * COLLECTION: App Check Handshake
     * Used exclusively to trigger the App Check pulse and log the debug token.
     */
    match /app-check-handshake/{document=**} {
      allow read: if isAppCheckVerified();
      allow write: if false; // Only the Admin SDK/Console should create these
    }

    /**
     * COLLECTION: Users
     * Users can manage their own data; Admins have full override access.
     */
    match /users/{userId} {
      allow read, write: if (request.auth != null && request.auth.uid == userId) || isAdmin();
    }

    /**
     * GLOBAL: All other collections (Bills, Committees, etc.)
     * Upgraded from "if true" to "if isAppCheckVerified()" to prevent scraping.
     */
    match /{document=**} {
      // Require the request to come from your portal, but allow anyone to view.
      allow read: if isAppCheckVerified();
      
      // Keep your existing admin-only write restriction.
      allow write: if isAdmin();
    }
  }
}